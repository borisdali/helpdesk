services:
  # AI Governance: Audit daemon with approval workflows
  auditd:
    build:
      context: ../../..
      dockerfile: helpdesk/Dockerfile
    image: helpdesk:latest
    command: ["/usr/local/bin/auditd"]
    environment:
      # Core audit configuration
      HELPDESK_AUDIT_ADDR: "0.0.0.0:1199"
      HELPDESK_AUDIT_DB: /data/audit/audit.db
      HELPDESK_AUDIT_SOCKET: /data/audit/audit.sock
      # Set so that approvals/govexplain binaries exec'd inside this container
      # can find auditd without requiring -e or an explicit --url flag.
      HELPDESK_AUDIT_URL: http://localhost:1199
      # Policy (for governance info / govexplain endpoint).
      # Empty default: auditd loads the mounted policy file unconditionally so
      # that govexplain hypothetical checks work out of the box.
      # Set HELPDESK_POLICY_ENABLED=false in .env to suppress loading entirely.
      HELPDESK_POLICY_ENABLED: ${HELPDESK_POLICY_ENABLED:-}
      HELPDESK_POLICY_FILE: /etc/helpdesk/policies.yaml
      # Approval notification (optional)
      HELPDESK_APPROVAL_WEBHOOK: ${HELPDESK_APPROVAL_WEBHOOK:-}
      HELPDESK_APPROVAL_BASE_URL: ${HELPDESK_APPROVAL_BASE_URL:-http://localhost:1199}
      # Email notifications (optional)
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      HELPDESK_EMAIL_FROM: ${HELPDESK_EMAIL_FROM:-}
      HELPDESK_EMAIL_TO: ${HELPDESK_EMAIL_TO:-}
    volumes:
      - audit-data:/data/audit
      - ${HELPDESK_POLICY_FILE_HOST:-./policies.example.yaml}:/etc/helpdesk/policies.yaml:ro
    ports:
      - "1199:1199"
    restart: unless-stopped

  database-agent:
    build:
      context: ../../..
      dockerfile: helpdesk/Dockerfile
    image: helpdesk:latest
    command: ["/usr/local/bin/database-agent"]
    environment:
      HELPDESK_AGENT_ADDR: "0.0.0.0:1100"
      HELPDESK_AGENT_URL: "http://database-agent:1100"
      HELPDESK_INFRA_CONFIG: /etc/helpdesk/infrastructure.json
      HELPDESK_MODEL_VENDOR: ${HELPDESK_MODEL_VENDOR}
      HELPDESK_MODEL_NAME: ${HELPDESK_MODEL_NAME}
      HELPDESK_API_KEY: ${HELPDESK_API_KEY}
      # AI Governance
      HELPDESK_OPERATING_MODE: ${HELPDESK_OPERATING_MODE:-}
      HELPDESK_AUDIT_ENABLED: "true"
      HELPDESK_AUDIT_URL: http://auditd:1199
      HELPDESK_POLICY_ENABLED: ${HELPDESK_POLICY_ENABLED:-false}
      HELPDESK_POLICY_FILE: /etc/helpdesk/policies.yaml
      HELPDESK_APPROVAL_TIMEOUT: ${HELPDESK_APPROVAL_TIMEOUT:-5m}
      # Optional: set PGPASSWORD in .env as a single global DB password.
      # This is not secure and not recommended for anything beyond
      # throw-away development databases.
      # For per-host credentials mount a .pgpass file via PGPASSFILE below.
      PGPASSWORD: ${PGPASSWORD:-}
    volumes:
      - ${HELPDESK_INFRA_CONFIG:-./infrastructure.json}:/etc/helpdesk/infrastructure.json:ro
      - ${HELPDESK_POLICY_FILE_HOST:-./policies.example.yaml}:/etc/helpdesk/policies.yaml:ro
      - ${PGPASSFILE:-./.pgpass}:/root/.pgpass:ro
    ports:
      - "1100:1100"
    restart: unless-stopped
    depends_on:
      - auditd

  k8s-agent:
    build:
      context: ../../..
      dockerfile: helpdesk/Dockerfile
    image: helpdesk:latest
    command: ["/usr/local/bin/k8s-agent"]
    environment:
      HELPDESK_AGENT_ADDR: "0.0.0.0:1102"
      HELPDESK_AGENT_URL: "http://k8s-agent:1102"
      HELPDESK_INFRA_CONFIG: /etc/helpdesk/infrastructure.json
      HELPDESK_MODEL_VENDOR: ${HELPDESK_MODEL_VENDOR}
      HELPDESK_MODEL_NAME: ${HELPDESK_MODEL_NAME}
      HELPDESK_API_KEY: ${HELPDESK_API_KEY}
      # AI Governance
      HELPDESK_OPERATING_MODE: ${HELPDESK_OPERATING_MODE:-}
      HELPDESK_AUDIT_ENABLED: "true"
      HELPDESK_AUDIT_URL: http://auditd:1199
      HELPDESK_POLICY_ENABLED: ${HELPDESK_POLICY_ENABLED:-false}
      HELPDESK_POLICY_FILE: /etc/helpdesk/policies.yaml
      HELPDESK_APPROVAL_TIMEOUT: ${HELPDESK_APPROVAL_TIMEOUT:-5m}
    volumes:
      - ${KUBECONFIG:-~/.kube/config}:/root/.kube/config:ro
      - ${HELPDESK_INFRA_CONFIG:-./infrastructure.json}:/etc/helpdesk/infrastructure.json:ro
      - ${HELPDESK_POLICY_FILE_HOST:-./policies.example.yaml}:/etc/helpdesk/policies.yaml:ro
    ports:
      - "1102:1102"
    restart: unless-stopped
    depends_on:
      - auditd

  incident-agent:
    build:
      context: ../../..
      dockerfile: helpdesk/Dockerfile
    image: helpdesk:latest
    command: ["/usr/local/bin/incident-agent"]
    environment:
      HELPDESK_AGENT_ADDR: "0.0.0.0:1104"
      HELPDESK_AGENT_URL: "http://incident-agent:1104"
      HELPDESK_MODEL_VENDOR: ${HELPDESK_MODEL_VENDOR}
      HELPDESK_MODEL_NAME: ${HELPDESK_MODEL_NAME}
      HELPDESK_API_KEY: ${HELPDESK_API_KEY}
      HELPDESK_INCIDENT_DIR: /data/incidents
      # AI Governance
      HELPDESK_OPERATING_MODE: ${HELPDESK_OPERATING_MODE:-}
      HELPDESK_AUDIT_ENABLED: "true"
      HELPDESK_AUDIT_URL: http://auditd:1199
    volumes:
      - incidents:/data/incidents
      - ${KUBECONFIG:-~/.kube/config}:/root/.kube/config:ro
    ports:
      - "1104:1104"
    restart: unless-stopped
    depends_on:
      - auditd

  # Research agent for Gemini models - provides web search via GoogleSearch.
  # GoogleSearch cannot be combined with function declarations, so this agent
  # handles web searches separately. Harmless to run with Anthropic models.
  research-agent:
    build:
      context: ../../..
      dockerfile: helpdesk/Dockerfile
    image: helpdesk:latest
    command: ["/usr/local/bin/research-agent"]
    environment:
      HELPDESK_AGENT_ADDR: "0.0.0.0:1106"
      HELPDESK_AGENT_URL: "http://research-agent:1106"
      HELPDESK_MODEL_VENDOR: ${HELPDESK_MODEL_VENDOR}
      HELPDESK_MODEL_NAME: ${HELPDESK_MODEL_NAME}
      HELPDESK_API_KEY: ${HELPDESK_API_KEY}
      # AI Governance
      HELPDESK_OPERATING_MODE: ${HELPDESK_OPERATING_MODE:-}
      HELPDESK_AUDIT_ENABLED: "true"
      HELPDESK_AUDIT_URL: http://auditd:1199
    ports:
      - "1106:1106"
    restart: unless-stopped
    depends_on:
      - auditd

  gateway:
    build:
      context: ../../..
      dockerfile: helpdesk/Dockerfile
    image: helpdesk:latest
    command: ["/usr/local/bin/gateway"]
    environment:
      HELPDESK_GATEWAY_ADDR: "0.0.0.0:8080"
      HELPDESK_AGENT_URLS: "http://database-agent:1100,http://k8s-agent:1102,http://incident-agent:1104,http://research-agent:1106"
      HELPDESK_MODEL_VENDOR: ${HELPDESK_MODEL_VENDOR}
      HELPDESK_MODEL_NAME: ${HELPDESK_MODEL_NAME}
      HELPDESK_API_KEY: ${HELPDESK_API_KEY}
      # AI Governance - enables /api/v1/governance endpoints
      HELPDESK_AUDIT_ENABLED: "true"
      HELPDESK_AUDIT_URL: http://auditd:1199
    ports:
      - "8080:8080"
    restart: unless-stopped
    depends_on:
      - auditd
      - database-agent
      - k8s-agent
      - incident-agent
      - research-agent

  orchestrator:
    build:
      context: ../../..
      dockerfile: helpdesk/Dockerfile
    image: helpdesk:latest
    command: ["/usr/local/bin/helpdesk"]
    environment:
      HELPDESK_AGENT_URLS: "http://database-agent:1100,http://k8s-agent:1102,http://incident-agent:1104,http://research-agent:1106"
      HELPDESK_MODEL_VENDOR: ${HELPDESK_MODEL_VENDOR}
      HELPDESK_MODEL_NAME: ${HELPDESK_MODEL_NAME}
      HELPDESK_API_KEY: ${HELPDESK_API_KEY}
      HELPDESK_INFRA_CONFIG: /etc/helpdesk/infrastructure.json
      # Streaming mode: "sse" (streaming) or "none" (disabled, default)
      # Set to "none" to work around ADK REPL bug in containers
      HELPDESK_STREAMING_MODE: ${HELPDESK_STREAMING_MODE:-none}
      # AI Governance
      HELPDESK_OPERATING_MODE: ${HELPDESK_OPERATING_MODE:-}
      HELPDESK_AUDIT_ENABLED: "true"
      HELPDESK_AUDIT_URL: http://auditd:1199
    volumes:
      - ${HELPDESK_INFRA_CONFIG:-./infrastructure.json}:/etc/helpdesk/infrastructure.json:ro
    stdin_open: true
    tty: true
    profiles:
      - interactive
    depends_on:
      - database-agent
      - k8s-agent
      - incident-agent
      - research-agent

  # AI Governance: Real-time audit monitoring and alerting
  # Enable with: docker compose --profile governance up -d
  auditor:
    build:
      context: ../../..
      dockerfile: helpdesk/Dockerfile
    image: helpdesk:latest
    command:
      - /usr/local/bin/auditor
      - -socket=/data/audit/audit.sock
      - -webhook=${HELPDESK_ALERT_WEBHOOK:-}
    environment:
      # Email alerting (optional)
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      HELPDESK_EMAIL_FROM: ${HELPDESK_EMAIL_FROM:-}
      HELPDESK_EMAIL_TO: ${HELPDESK_EMAIL_TO:-}
    volumes:
      - audit-data:/data/audit:ro
    profiles:
      - governance
    restart: unless-stopped
    depends_on:
      - auditd

  # AI Governance: Compliance reporter (one-shot, run with: docker compose run govbot)
  # Enable with: docker compose --profile governance run govbot
  govbot:
    build:
      context: ../../..
      dockerfile: helpdesk/Dockerfile
    image: helpdesk:latest
    command:
      - /usr/local/bin/govbot
      - -gateway=http://gateway:8080
      - -since=${GOVBOT_SINCE:-24h}
      - -webhook=${GOVBOT_WEBHOOK:-}
    profiles:
      - governance
    depends_on:
      - auditd
      - gateway

  # AI Governance: Security responder bot
  # Enable with: docker compose --profile governance up -d
  secbot:
    build:
      context: ../../..
      dockerfile: helpdesk/Dockerfile
    image: helpdesk:latest
    command:
      - /usr/local/bin/secbot
      - -socket=/data/audit/audit.sock
      - -gateway=http://gateway:8080
    volumes:
      - audit-data:/data/audit:ro
    ports:
      - "9091:9091"
    profiles:
      - governance
    restart: unless-stopped
    depends_on:
      - auditd
      - gateway

volumes:
  incidents:
  audit-data:
